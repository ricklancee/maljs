"use strict";var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var a=n[t];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(e,a.key,a)}}return function(n,t,a){if(t)e(n.prototype,t);if(a)e(n,a);return n}}();function _classCallCheck(e,n){if(!(e instanceof n)){throw new TypeError("Cannot call a class as a function")}}var MALjs=function(){function e(n,t){var a=this;_classCallCheck(this,e);if(!n||!t){throw new Error("MALjs requires a myanimelist.net username and password.")}this._user=n;this._password=t;this._base="https://myanimelist.net";this._parser=new DOMParser;this.anime={search:function e(n){return a.search(n,"anime")},list:function e(){return a.list("anime")},add:function e(n,t){return a.add(n,t,"anime")},update:function e(n,t){return a.update(n,t,"anime")},delete:function e(n,t){return a.delete(n,"anime")}};this.manga={search:function e(n){return a.search(n,"manga")},list:function e(){return a.list("manga")},add:function e(n,t){return a.add(n,t,"manga")},update:function e(n,t){return a.update(n,t,"manga")},delete:function e(n,t){return a.delete(n,"manga")}}}_createClass(e,[{key:"search",value:function e(n,t){this._checkType(t);return this._get(this._base+"/api/"+t+"/search.xml?q="+n)}},{key:"list",value:function e(n){this._checkType(n);return this._get(this._base+"/malappinfo.php?u="+this._user+"&status=all&type="+n)}},{key:"add",value:function e(n,t,a){this._checkType(a);if(!t.entry){t={entry:t}}return this._post(this._base+"/api/"+a+"list/add/"+n+".xml",t)}},{key:"update",value:function e(n,t,a){this._checkType(a);if(!t.entry){t={entry:t}}return this._post(this._base+"/api/"+a+"list/update/"+n+".xml",t)}},{key:"delete",value:function e(n,t){this._checkType(t);return this._post(this._base+"/api/"+t+"list/delete/"+n+".xml")}},{key:"verifyCredentials",value:function e(){return this._get(this._base+"/api/account/verify_credentials.xml")}},{key:"_checkType",value:function e(n){if(n!=="anime"&&n!=="manga"){throw new Error("Only allowed types are anime and manga. incorrect type: "+n+" given.")}}},{key:"_parseXml",value:function e(n){var t=this._parser.parseFromString(n,"text/xml");if(t.documentElement.nodeName==="html"){return false}return t}},{key:"_toJson",value:function e(n){var t=n.childNodes;var a={};for(var r=0;r<t.length;r++){var i=t[r];if(i.nodeName==="myanimelist"){a[i.nodeName]={}}else{a[i.nodeName]=[]}var s=i.childNodes;for(var o=0;o<s.length;o++){var u=s[o];var l={};if(u.nodeName==="#text")continue;var c=u.childNodes;for(var d=0;d<c.length;d++){var f=c[d];if(f.nodeName==="#text")continue;var m=f.innerHTML;if(f.nodeName==="id"||f.nodeName==="episodes"){m=parseInt(m,10)}l[f.nodeName]=m}if(i.nodeName==="myanimelist"){if(u.nodeName==="anime"||u.nodeName==="manga"){if(!a[i.nodeName][u.nodeName]){a[i.nodeName][u.nodeName]=[]}a[i.nodeName][u.nodeName].push(l)}else{a[i.nodeName][u.nodeName]=l}}else{a[i.nodeName].push(l)}}}return a}},{key:"_toXml",value:function e(n){var t='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';function a(e){for(var n in e){if(e.hasOwnProperty(n)){if(e[n].constructor==Object){t+="<"+n+">";a(e[n]);t+="</"+n+">"}else{t+="<"+n+">"+e[n]+"</"+n+">"}}}}a(n);return t}},{key:"_get",value:function e(n){var t=this;return new Promise(function(e,a){var r=new XMLHttpRequest;r.open("GET",n,true,t._user,t._password);r.onload=function(){if(r.status===200){var n=r.response;var i=t._parseXml(n);if(i){e(t._toJson(i))}else{a("Failed to parse xml")}}else{a("request failed")}};r.onerror=function(){a("request failed")};r.send()})}},{key:"_post",value:function e(n){var t=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return new Promise(function(e,r){var i=new XMLHttpRequest;i.open("POST",n,true,t._user,t._password);i.setRequestHeader("Content-type","application/x-www-form-urlencoded");i.onload=function(){if(i.status===200||i.status===201){e(i.response)}else{r(i.response)}};i.onerror=function(){r("request failed")};if(a){var s=t._toXml(a);i.send("data="+s)}else{i.send()}})}}]);return e}();window.MALjs=MALjs;