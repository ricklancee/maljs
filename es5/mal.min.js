"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}return function(t,n,r){if(n)e(t.prototype,n);if(r)e(t,r);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}(function(){var e=typeof exports!=="undefined";var t;var n;if(e){t=require("xml2js");n=require("request")}var r=function(){function r(n,a){var s=this;_classCallCheck(this,r);if(!n||!a){throw new Error("MALjs requires a myanimelist.net username and password.")}this._user=n;this._password=a;this._base="https://myanimelist.net";this._parser=e?new t.Parser:new DOMParser;this.anime={search:function e(t){return s.search(t,"anime")},list:function e(){return s.list("anime")},add:function e(t,n){return s.add(t,n,"anime")},update:function e(t,n){return s.update(t,n,"anime")},delete:function e(t,n){return s.delete(t,"anime")}};this.manga={search:function e(t){return s.search(t,"manga")},list:function e(){return s.list("manga")},add:function e(t,n){return s.add(t,n,"manga")},update:function e(t,n){return s.update(t,n,"manga")},delete:function e(t,n){return s.delete(t,"manga")}}}_createClass(r,[{key:"search",value:function e(t,n){this._checkType(n);return this._get(this._base+"/api/"+n+"/search.xml?q="+t)}},{key:"list",value:function e(t){this._checkType(t);return this._get(this._base+"/malappinfo.php?u="+this._user+"&status=all&type="+t)}},{key:"add",value:function e(t,n,r){this._checkType(r);if(!n){return}if(!n.entry){n={entry:n}}return this._post(this._base+"/api/"+r+"list/add/"+t+".xml",n)}},{key:"update",value:function e(t,n,r){this._checkType(r);if(!n){return}if(!n.entry){n={entry:n}}return this._post(this._base+"/api/"+r+"list/update/"+t+".xml",n)}},{key:"delete",value:function e(t,n){this._checkType(n);return this._post(this._base+"/api/"+n+"list/delete/"+t+".xml")}},{key:"verifyCredentials",value:function e(){return this._get(this._base+"/api/account/verify_credentials.xml")}},{key:"_checkType",value:function e(t){if(t!=="anime"&&t!=="manga"){throw new Error("Only allowed types are anime and manga. incorrect type: "+t+" given.")}}},{key:"_xmlToJson",value:function t(n){var r=this;return new Promise(function(t,a){if(e){r._parser.parseString(n,function(e,n){if(n.anime&&n.anime.entry){var r=n.anime.entry;delete n.anime.entry;n.anime=r}if(n.manga&&n.manga.entry){var r=n.manga.entry;delete n.manga.entry;n.manga=r}if(e){a(e)}else{t(n)}})}else{var s=r._parser.parseFromString(n,"text/xml");if(s.documentElement.nodeName==="html"){a("Failed to parse xml.")}else{t(r._domToJson(s))}}})}},{key:"_domToJson",value:function e(t){var n=t.childNodes;var r={};for(var a=0;a<n.length;a++){var s=n[a];if(s.nodeName==="myanimelist"){r[s.nodeName]={}}else{r[s.nodeName]=[]}var i=s.childNodes;for(var o=0;o<i.length;o++){var u=i[o];var l={};if(u.nodeName==="#text")continue;var d=u.childNodes;for(var f=0;f<d.length;f++){var c=d[f];if(c.nodeName==="#text")continue;var m=c.innerHTML;if(c.nodeName==="id"||c.nodeName==="episodes"){m=parseInt(m,10)}l[c.nodeName]=m}if(s.nodeName==="myanimelist"){if(u.nodeName==="anime"||u.nodeName==="manga"){if(!r[s.nodeName][u.nodeName]){r[s.nodeName][u.nodeName]=[]}r[s.nodeName][u.nodeName].push(l)}else{r[s.nodeName][u.nodeName]=l}}else{r[s.nodeName].push(l)}}}return r}},{key:"_toXml",value:function e(t){var n='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';function r(e){for(var t in e){if(e.hasOwnProperty(t)){if(e[t].constructor==Object){n+="<"+t+">";r(e[t]);n+="</"+t+">"}else{n+="<"+t+">"+e[t]+"</"+t+">"}}}}r(t);return n}},{key:"_get",value:function t(n){var r=this;return new Promise(function(t,a){if(e){r._getForNode(n,t,a)}else{r._getForBrowser(n,t,a)}})}},{key:"_getForNode",value:function e(t,r,a){var s=this;n.get(t,function(e,t,n){if(!e&&t.statusCode==200){s._xmlToJson(n).then(r).catch(a)}else{a("request failed")}}).auth(this._user,this._password)}},{key:"_getForBrowser",value:function e(t,n,r){var a=this;var s=new XMLHttpRequest;s.open("GET",t,true,this._user,this._password);s.onload=function(){if(s.status===200){var e=s.response;a._xmlToJson(e).then(n).catch(r)}else{r("request failed")}};s.onerror=function(){r("request failed")};s.send()}},{key:"_post",value:function t(n){var r=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return new Promise(function(t,s){if(e){r._postForNode(n,a,t,s)}else{r._postForBrowser(n,a,t,s)}})}},{key:"_postForNode",value:function e(t,r,a,s){if(r){r=this._toXml(r);r={form:{data:r}}}n.post(t,r,function(e,t,n){if(!e&&(t.statusCode==200||t.statusCode===201)){a(n)}else{s("request failed")}}).auth(this._user,this._password)}},{key:"_postForBrowser",value:function e(t,n,r,a){var s=new XMLHttpRequest;s.open("POST",t,true,this._user,this._password);s.setRequestHeader("Content-type","application/x-www-form-urlencoded");s.onload=function(){if(s.status===200||s.status===201){r(s.response)}else{a(s.response)}};s.onerror=function(){a("request failed")};if(n){var i=this._toXml(n);s.send("data="+i)}else{s.send()}}}]);return r}();if(e){if(typeof module!=="undefined"&&module.exports){exports=module.exports=r}exports.MALjs=r}else{window.MALjs=r}})();