"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(e,a.key,a)}}return function(t,n,a){if(n)e(t.prototype,n);if(a)e(t,a);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}(function(){var e=this;var t=typeof exports!=="undefined";var n;var a;if(t){n=require("xml2js");a=require("request")}var r=function(){function e(a,r){var s=this;_classCallCheck(this,e);if(!a||!r){throw new Error("MALjs requires a myanimelist.net username and password.")}this._user=a;this._password=r;this._base="https://myanimelist.net";this._parser=t?new n.Parser:new DOMParser;this.anime={search:function e(t){return s.search(t,"anime")},list:function e(){return s.list("anime")},add:function e(t,n){return s.add(t,n,"anime")},update:function e(t,n){return s.update(t,n,"anime")},delete:function e(t,n){return s.delete(t,"anime")}};this.manga={search:function e(t){return s.search(t,"manga")},list:function e(){return s.list("manga")},add:function e(t,n){return s.add(t,n,"manga")},update:function e(t,n){return s.update(t,n,"manga")},delete:function e(t,n){return s.delete(t,"manga")}}}_createClass(e,[{key:"search",value:function e(t,n){this._checkType(n);return this._get(this._base+"/api/"+n+"/search.xml?q="+t)}},{key:"list",value:function e(t){this._checkType(t);return this._get(this._base+"/malappinfo.php?u="+this._user+"&status=all&type="+t)}},{key:"add",value:function e(t,n,a){this._checkType(a);if(!n){return}if(!n.entry){n={entry:n}}return this._post(this._base+"/api/"+a+"list/add/"+t+".xml",n)}},{key:"update",value:function e(t,n,a){this._checkType(a);if(!n){return}if(!n.entry){n={entry:n}}return this._post(this._base+"/api/"+a+"list/update/"+t+".xml",n)}},{key:"delete",value:function e(t,n){this._checkType(n);return this._post(this._base+"/api/"+n+"list/delete/"+t+".xml")}},{key:"verifyCredentials",value:function e(){return this._get(this._base+"/api/account/verify_credentials.xml")}},{key:"_checkType",value:function e(t){if(t!=="anime"&&t!=="manga"){throw new Error("Only allowed types are anime and manga. incorrect type: "+t+" given.")}}},{key:"_xmlToJson",value:function e(n){var a=this;return new Promise(function(e,r){if(t){a._parser.parseString(n,function(t,n){if(n.anime&&n.anime.entry){var a=n.anime.entry;delete n.anime.entry;n.anime=a}if(n.manga&&n.manga.entry){var a=n.manga.entry;delete n.manga.entry;n.manga=a}if(t){r(t)}else{e(n)}})}else{var s=a._parser.parseFromString(n,"text/xml");if(s.documentElement.nodeName==="html"){r("Failed to parse xml.")}else{e(a._domToJson(s))}}})}},{key:"_domToJson",value:function e(t){var n=t.childNodes;var a={};for(var r=0;r<n.length;r++){var s=n[r];if(s.nodeName==="myanimelist"){a[s.nodeName]={}}else{a[s.nodeName]=[]}var i=s.childNodes;for(var o=0;o<i.length;o++){var u=i[o];var l={};if(u.nodeName==="#text")continue;var d=u.childNodes;for(var f=0;f<d.length;f++){var c=d[f];if(c.nodeName==="#text")continue;var m=c.innerHTML;if(c.nodeName==="id"||c.nodeName==="episodes"){m=parseInt(m,10)}l[c.nodeName]=m}if(s.nodeName==="myanimelist"){if(u.nodeName==="anime"||u.nodeName==="manga"){if(!a[s.nodeName][u.nodeName]){a[s.nodeName][u.nodeName]=[]}a[s.nodeName][u.nodeName].push(l)}else{a[s.nodeName][u.nodeName]=l}}else{a[s.nodeName].push(l)}}}return a}},{key:"_toXml",value:function e(t){var n='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';function a(e){for(var t in e){if(e.hasOwnProperty(t)){if(e[t].constructor==Object){n+="<"+t+">";a(e[t]);n+="</"+t+">"}else{n+="<"+t+">"+e[t]+"</"+t+">"}}}}a(t);return n}},{key:"_get",value:function e(n){var a=this;return new Promise(function(e,r){if(t){a._getForNode(n,e,r)}else{a._getForBrowser(n,e,r)}})}},{key:"_getForNode",value:function e(t,n,r){var s=this;a.get(t,function(e,t,a){if(!e&&t.statusCode==200){s._xmlToJson(a).then(n).catch(r)}else{r("request failed")}}).auth(this._user,this._password)}},{key:"_getForBrowser",value:function e(t,n,a){var r=this;var s=new XMLHttpRequest;s.open("GET",t,true,this._user,this._password);s.onload=function(){if(s.status===200){var e=s.response;r._xmlToJson(e).then(n).catch(a)}else{a("request failed")}};s.onerror=function(){a("request failed")};s.send()}},{key:"_post",value:function e(n){var a=this;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return new Promise(function(e,s){if(t){a._postForNode(n,r,e,s)}else{a._postForBrowser(n,r,e,s)}})}},{key:"_postForNode",value:function e(t,n,r,s){if(n){n=this._toXml(n);n={form:{data:n}}}a.post(t,n,function(e,t,n){if(!e&&(t.statusCode==200||t.statusCode===201)){r(n)}else{s("request failed")}}).auth(this._user,this._password)}},{key:"_postForBrowser",value:function e(t,n,a,r){var s=new XMLHttpRequest;s.open("POST",t,true,this._user,this._password);s.setRequestHeader("Content-type","application/x-www-form-urlencoded");s.onload=function(){if(s.status===200||s.status===201){a(s.response)}else{r(s.response)}};s.onerror=function(){r("request failed")};if(n){var i=this._toXml(n);s.send("data="+i)}else{s.send()}}}]);return e}();if(t){if(typeof module!=="undefined"&&module.exports){exports=module.exports=r}exports.MALjs=r}else{e.MALjs=r}}).call(undefined);